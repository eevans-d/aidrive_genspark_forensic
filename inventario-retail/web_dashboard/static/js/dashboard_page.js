// Scripts específicos de dashboard
let activityChart, providersChart, stockByProviderChart, weeklySalesChart;
if (typeof Chart !== 'undefined') {
	Chart.defaults.responsive = true;
	Chart.defaults.maintainAspectRatio = false;
}

async function initActivityChart(){const data=await loadData('/api/stock-timeline?days=7');if(!data)return;const dates=[...new Set(data.map(d=>d.fecha))].sort();const entradas=dates.map(date=>{const entrada=data.find(d=>d.fecha===date&&d.tipo==='entrada');return entrada?entrada.productos:0;});const salidas=dates.map(date=>{const salida=data.find(d=>d.fecha===date&&d.tipo==='salida');return salida?salida.productos:0;});document.getElementById('activityChartLoading')?.classList.add('d-none');if(!dates.length){document.getElementById('activityChartEmpty')?.classList.remove('d-none');return;}const ctx=document.getElementById('activityChart').getContext('2d');activityChart=new Chart(ctx,{type:'line',data:{labels:dates,datasets:[{label:'Entradas',data:entradas,borderColor:'#28a745',backgroundColor:'rgba(40,167,69,0.1)',tension:.4},{label:'Salidas',data:salidas,borderColor:'#dc3545',backgroundColor:'rgba(220,53,69,0.1)',tension:.4}]},options:{plugins:{title:{display:true,text:'Movimientos de Stock por Día'},legend:{display:true,position:'top'}},scales:{y:{beginAtZero:true,title:{display:true,text:'Cantidad de Productos'}}}}});}

async function initProvidersChart(){const data=await loadData('/api/providers');document.getElementById('providersChartLoading')?.classList.add('d-none');if(!data||data.length===0){document.getElementById('providersChartEmpty')?.classList.remove('d-none');return;}const topProviders=data.filter(p=>p.total_pedidos>0).sort((a,b)=>b.total_pedidos-a.total_pedidos).slice(0,5);const labels=topProviders.map(p=>p.codigo);const values=topProviders.map(p=>p.total_pedidos);const colors=['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'];const ctx=document.getElementById('providersChart').getContext('2d');providersChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},options:{plugins:{title:{display:true,text:'Top 5 Proveedores'},legend:{display:true,position:'bottom'}}}});} 

async function initStockByProviderChart(){const data=await loadData('/api/stock-by-provider');document.getElementById('stockByProviderLoading')?.classList.add('d-none');if(!data||data.length===0){document.getElementById('stockByProviderEmpty')?.classList.remove('d-none');return;}const labels=data.map(d=>d.codigo||d.nombre);const values=data.map(d=>d.stock_total||0);const ctx=document.getElementById('stockByProviderChart').getContext('2d');stockByProviderChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Stock total',data:values,backgroundColor:'#36A2EB'}]},options:{plugins:{legend:{display:false},title:{display:true,text:'Top Proveedores por Stock'},tooltip:{enabled:true,callbacks:{label:ctx=>`Stock: ${ctx.parsed.y}`}}},scales:{y:{beginAtZero:true,title:{display:true,text:'Unidades'}}}}});}

async function initWeeklySalesChart(){const data=await loadData('/api/weekly-sales?weeks=8');document.getElementById('weeklySalesLoading')?.classList.add('d-none');if(!data||data.length===0||data[0].error){document.getElementById('weeklySalesEmpty')?.classList.remove('d-none');return;}const labels=data.map(d=>d.semana);const pedidos=data.map(d=>d.pedidos||0);const productos=data.map(d=>d.productos||0);const ctx=document.getElementById('weeklySalesChart').getContext('2d');weeklySalesChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Pedidos',data:pedidos,borderColor:'#007bff',backgroundColor:'rgba(0,123,255,0.1)',tension:.3},{label:'Productos',data:productos,borderColor:'#17a2b8',backgroundColor:'rgba(23,162,184,0.1)',tension:.3}]},options:{plugins:{title:{display:true,text:'Evolución semanal (últimas 8 semanas)'},legend:{display:true,position:'top'}},scales:{y:{beginAtZero:true}}}});}

function loadProviders(){window.location.href='/providers';}
function loadAnalytics(){window.location.href='/analytics';}
async function refreshData(){showAlert('Actualizando datos...','info');await refreshMetrics();if(activityChart)activityChart.destroy();if(providersChart)providersChart.destroy();if(stockByProviderChart)stockByProviderChart.destroy();if(weeklySalesChart)weeklySalesChart.destroy();await initActivityChart();await initProvidersChart();await initStockByProviderChart();await initWeeklySalesChart();showAlert('Datos actualizados exitosamente!','success');}

// Reproducción de alerta de stock
document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{initActivityChart();initProvidersChart();initStockByProviderChart();initWeeklySalesChart();},500);const flags=document.getElementById('dashboardFlags');if(flags&&flags.dataset.tieneCritico==='1'){const audio=document.getElementById('alertaSonora');if(audio){try{audio.play();}catch(_){}showToast('¡Hay productos con stock crítico o agotado!','danger',6000);}window.addEventListener('load',()=>{const a2=document.getElementById('alertaSonora');if(a2){try{a2.play();}catch(_){} } });}});

// Toast notifications
function showToast(message,type='info',delay=4000){const toastId=`toast-${Date.now()}`;const color= type==='success'?'bg-success': type==='danger'?'bg-danger': type==='warning'?'bg-warning text-dark':'bg-info';const icon= type==='success'?'fa-check-circle': type==='danger'?'fa-exclamation-triangle': type==='warning'?'fa-exclamation-circle':'fa-info-circle';const html=`<div id="${toastId}" class="toast align-items-center text-white ${color}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}"><div class="d-flex"><div class="toast-body"><i class="fas ${icon} me-2"></i> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;const cont=document.getElementById('toastContainer');if(cont){cont.insertAdjacentHTML('beforeend',html);const toastEl=document.getElementById(toastId);const t=new bootstrap.Toast(toastEl);t.show();toastEl.addEventListener('hidden.bs.toast',()=>toastEl.remove());}}

// Badge alerta stock in header
document.addEventListener('DOMContentLoaded',()=>{const flags=document.getElementById('dashboardFlags');if(flags&&flags.dataset.tieneCritico==='1'){const h1=document.querySelector('h1.display-4');if(h1&&!document.getElementById('badgeAlertaStock')){h1.insertAdjacentHTML('beforeend',' <span id="badgeAlertaStock" class="badge bg-danger ms-2">ALERTA STOCK</span>');}}});
