// Scripts específicos de analytics
const topProductsData = JSON.parse(document.getElementById('topProductsDataJson')?.textContent || '[]');
const pageSize=5;let currentPage=1;
function renderTopProductsTable(){const tbody=document.getElementById('topProductsTableBody');const info=document.getElementById('topProductsPaginationInfo');if(!tbody)return;tbody.innerHTML='';if(!topProductsData||topProductsData.length===0){tbody.innerHTML='<tr><td colspan="4" class="text-center text-muted">Sin datos</td></tr>';if(info) info.textContent='';return;}const start=(currentPage-1)*pageSize;const end=Math.min(start+pageSize,topProductsData.length);for(let i=start;i<end;i++){const p=topProductsData[i];tbody.innerHTML+=`<tr><td>${i+1}</td><td>${p.producto}</td><td><span class='badge bg-success'>${p.cantidad_total}</span></td><td><span class='badge bg-info'>${p.pedidos}</span></td></tr>`;}if(info) info.textContent=`Mostrando ${start+1}-${end} de ${topProductsData.length}`;document.getElementById('topProductsPrev').disabled=currentPage===1;document.getElementById('topProductsNext').disabled=end>=topProductsData.length;}

document.addEventListener('DOMContentLoaded',()=>{renderTopProductsTable();document.getElementById('topProductsPrev').onclick=()=>{if(currentPage>1){currentPage--;renderTopProductsTable();}};document.getElementById('topProductsNext').onclick=()=>{if((currentPage*pageSize)<topProductsData.length){currentPage++;renderTopProductsTable();}};initTopProductsChart();initTrendsChart();});

async function initTopProductsChart(){const top5=topProductsData.slice(0,5);if(!top5||top5.length===0){document.getElementById('topProductsEmpty')?.classList.remove('d-none');return;}const labels=top5.map(p=>p.producto.substring(0,20)+'...');const values=top5.map(p=>p.cantidad_total);const colors=['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'];const ctx=document.getElementById('topProductsChart').getContext('2d');new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},options:{plugins:{title:{display:true,text:'Top 5 Productos'},legend:{display:true,position:'bottom'}}}});} 

async function initTrendsChart(){const trends=JSON.parse(document.getElementById('trendsDataJson')?.textContent||'[]');if(!trends||trends.length===0){document.getElementById('trendsEmpty')?.classList.remove('d-none');return;}const labels=trends.map(d=>d.mes);const pedidos=trends.map(d=>d.pedidos||0);const ctx=document.getElementById('trendsChart').getContext('2d');new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Pedidos',data:pedidos,borderColor:'#28a745',backgroundColor:'rgba(40,167,69,0.1)',tension:.3}]},options:{plugins:{title:{display:true,text:'Tendencias Mensuales'},legend:{display:false}},scales:{y:{beginAtZero:true}}}});} 

function exportTopProducts(){showAlert('Exportando Top Productos...','info');window.location.href='/api/export/top-products.csv';}
function exportTrends(){showAlert('Función en desarrollo','warning');}
